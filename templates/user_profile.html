<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Sidebars · Bootstrap v5.0</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/sidebars/">

  <link rel="stylesheet" href="/static/static/plugin/bootstrap-5.0.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/static/static/css/sidebars.css">
  <link href="/static/static/plugin/toastr/build/toastr.min.css" rel="stylesheet">


    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>


  </head>
  <body>

<main>

    <!-- sidebar -->
    <div class="d-none d-md-flex flex-column flex-shrink-0 p-3 text-white" style="width: 280px; background-color: rgb(73, 73, 73);">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
        <span class="fs-4">CRYPTO WALLET</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column lg-auto">
        <li class="nav-item">
            <a href="#" class="nav-link active fs-4" aria-current="page" id="profile_link">
            Профіль
            </a>
        </li>
        <li>
            <a href="#" class="nav-link text-white fs-4" id="wallets_link">
            Гаманець
            </a>
        </li>
        <li>
            <a href="#" class="nav-link text-white fs-4" id="ibay_link">
            iBay
            </a>
        </li>
        <li>
            <a href="#" class="nav-link text-white fs-4" id="chat_link">
            Чат
            </a>
        </li>
        </ul>
    </div>
    <div class="b-example-divider d-none d-lg-flex"></div>

    <!-- end sidebar -->

    <div class="container-fluid overflow-auto">
        <header class="d-none d-lg-block p-3 mb-3 border-bottom">
            <!-- <div class="container"> -->
              <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="#" class="d-flex align-items-center mb-2 mb-lg-0 text-dark text-decoration-none">
                  <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use xlink:href="#bootstrap"></use></svg>
                </a>

                <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0"></ul>



                </ul>
                <a href="#" class="username nav-link px-2 mx-3 link-dark fs-4" id="top_profile_link">Username</a>
                <img src="/static/static/image/empty_portrait.jpg" alt="mdo" width="50" height="50" class="portrait_jpg img-fluid">
              </div>
            <!-- </div> -->
          </header>

          <div class="collapse" id="navbarToggleExternalContent">
            <div class="bg-dark p-4">
              <ul>
                <li><h5 class="text-white h4">Collapsed content</h5></li>
                <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_profile_link">Профіль</a></span></li>
                <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_wallets_link">Гаманець</a></span></li>
                <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_ibay_link">iBay</a></span></li>
                <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_chat_link">Чат</a></span></li>
                <li><h5 class="username text-white h4">Username</h5></li>
              </ul>
            </div>
          </div>

          <nav class="d-flex d-lg-none navbar navbar-dark bg-dark">
            <div class="container-fluid">
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
            </div>
          </nav>

        <h3>Профіль користувача</h3>
        <form enctype="multipart/form-data" method='post' id="imageform">
          <div class="row my-3 border">
            <!-- <form id="imageform" enctype="multipart/form-data"> -->
            <div class="col-12 col-sm-10 col-md-8 col-lg-6 my-3" style="max-height: 270px;">
              <!-- user card -->
              <div class="card bg-dark text-white mb-3" style="max-width: 540px; max-height: 270px;">
                <div class="row g-0">
                  <div class="col-6 col-lg-4">
                    <img src="/static/static/image/empty_portrait.jpg" class="portrait_jpg img-fluid rounded-start" alt="Портрет користувача" style="max-height: 270px;" id="form-portrait">
                    <!-- <img src="#" class="portrait_jpg img-fluid rounded-start" alt="Портрет користувача" style="max-height: 270px;"> -->
                  </div>
                  <div class="col-6  col-lg-8">
                    <div class="card-body">
                      <h5 class="username card-title">Username</h5>
                      <div class="row">
                        <div class="col-12 col-lg-6">
                          <button type="button" id="image_button" class="btn btn-primary mt-5 mx-1">Оновити</button>

                          <!-- <form enctype="multipart/form-data" method='post' id="imageform"> -->
                            <input type="file" id="imageInput" name="photo" accept="image/png, image/jpeg" hidden/>
                          <!-- </form> -->

                        </div>
                        <div class="col-12 col-lg-6">
                          <button type="button" class="btn btn-light mt-5 mx-1" id="delete_image_button">Видалити</button>
                          <input type="checkbox" id="delete_check_box">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- end user card -->
            <!-- change user data form -->
            <div class="col-12">
              <div class="row">

                <div class="col-12 col-lg-6">
                  <div class="form-group row my-3">
                    <label for="inputUsername" class="col-sm-2 col-form-label">Юзернейм</label>
                    <div class="col-sm-10">
                      <input class="form-control" id="inputUsername" placeholder="Username" name="username">
                    </div>
                  </div>
                </div>

                <div class="col-12 col-lg-6">
                  <div class="form-group row my-3">
                    <label for="inputEmail" class="col-sm-2 col-form-label">Email</label>
                    <div class="col-sm-10">
                      <input class="form-control" id="inputEmail" placeholder="Email" name="email">
                    </div>
                  </div>
                </div>

              </div>

              <div class="row">
                <div class="col-12 col-lg-6">
                  <div class="form-group row my-3">
                    <label for="inputPassword" class="col-sm-2 col-form-label">пароль</label>
                    <div class="col-sm-10">
                      <input type="password" class="form-control" id="inputPassword" placeholder="пароль" name="password">
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <div class="form-group row my-3">
                    <label for="inputRepeatPassword" class="col-sm-2 col-form-label">повторіть пароль</label>
                    <div class="col-sm-10">
                      <input type="password" class="form-control" id="inputRepeatPassword" placeholder="повторіть пароль" name="repeat_password">
                    </div>
                  </div>
                </div>
              </div>


            <!-- </form> -->
            <div class="row">
              <div class="col-4">
                <button type="button" class="btn btn-success mt-1 mb-3" id="save_button">Зберігти</button>
              </div>
            </div>
            </div>
            <!-- end change user data form -->
          </div>
        </form>
        <h3>Статистика</h3>
        <div class="row my-3 border">
          <div class="col-12 my-3">
            <h5>Повідомлень в чаті: 200</h5>
            <h5>Кількість гаманців: 4</h5>
          </div>
        </div>

        <h3>Управління гаманцями</h3>
        <div class="row my-3 border py-3" id="profile_wallet_container">
          <div class="col-11 text-center" id="adding_buttons">
            <button type="button" class="btn btn-success mt-5 mx-1" data-bs-toggle="modal" data-bs-target="#import_wallet_modal">Імпортувати ETH гаманець</button>
            <button type="button" class="btn btn-success mt-5 mx-1" id="create_etc_wallet_button">Create ETH гаманець</button>
          </div>
        </div>

        <div class="modal" id="import_wallet_modal">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

              <div class="modal-header">
                <h4 class="modal-title">Імпортувати ETH гаманець</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body">
                <div class="mb-3">
                  <label for="adding_wallet_private_key" class="form-label">private key гаманця</label>
                  <input class="form-control" id="adding_wallet_private_key">
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="send_import_wallet_data">Імпортувати гаманець</button>
              </div>
            </div>
          </div>
        </div>



    </div>

    </main>

<script type="text/javascript" src="/static/static/plugin/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="/static/static/plugin/toastr/build/toastr.min.js"></script>
<script type="text/javascript" src="/static/static/plugin/bootstrap-5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="/static/static/js/sidebars.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.min.js"></script>


<script>


  window.onload = function() {
    $(document).ready(function () {


      var cookie_data = document.cookie

      for (var cookie of cookie_data.split('; ')){
        if (cookie.startsWith('access_token=')){
          var access_token = cookie.replace('access_token=', '')

          // request validate password
          $.ajax({
            url: window.location.href.replace('profile/', 'validate_access_token/'),
            type: "POST",
            data: JSON.stringify({'access_token': access_token}),
            processData: false,
            contentType: false,
            success: function(result){
              if(result['result'] == false)
              window.location.href = window.location.href.replace('profile/', 'login/')
            }
          });

          // request get users data
          $.ajax({
            url: window.location.href.replace('profile/', 'get_current_user_data/'),
            type: "POST",
            data: JSON.stringify({'access_token': access_token}),
            processData: false,
            contentType: false,
            success: function(result){

              var username_data = result['username']
              var email_data = result['email']
              $('#inputUsername').val(username_data)

              for(element of $("[class^='username']")){
                    $(element).text(username_data)
              }

              $('#inputEmail').val(email_data).attr("readonly", true)



              $("[class^='portrait_jpg']").each(function(image_obj){

                if(result['photo_url'] == null){
                  // console.log(result['photo_url'])
                  // console.log('opt 1')
                } else {
                  // console.log(result['photo_url'])
                  // console.log('opt 2')
                  $(this)[0].src=result['photo_url']
                }

              });


            },
            error: function(){
              console.log('Error!')
            }

          })

        }
      }


      $('#profile_link').attr('href', window.location.href)
      $('#top_profile_link').attr('href', window.location.href)
      $('#mobile_profile_link').attr('href', window.location.href)


      $('#wallets_link').attr('href', window.location.href.replace('users/profile/', 'wallets/'))
      $('#mobile_wallets_link').attr('href', window.location.href.replace('users/profile/', 'wallets/'))


      $('#ibay_link').attr('href', window.location.href.replace('users/profile/', 'ibay/'))
      $('#mobile_ibay_link').attr('href', window.location.href.replace('users/profile/', 'ibay/'))


      $('#chat_link').attr('href', window.location.href.replace('profile/', 'chat/'))
      $('#mobile_chat_link').attr('href', window.location.href.replace('profile/', 'chat/'))







      // <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_profile_link">Профіль</a></span></li>
      // <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_wallets_link">Гаманець</a></span></li>
      // <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_ibay_link">iBay</a></span></li>
      // <li><span class="text-white"><a href="#" class="link-light" style="text-decoration:none" id="mobile_chat_link">Чат</a></span></li>







      $('#image_button').on('click', function(){
        $('#imageInput').trigger('click')
      })




    $('#imageInput').on('change', function(){
      var input = $(this)
      var output = $(this).closest("form").find("img[id='form-portrait']")
      var reader = new FileReader();
      reader.onload = function () {
            output.attr("src", reader.result);
        };
      reader.readAsDataURL(input[0].files[0]);
      $('#delete_check_box').prop('checked', false);


      // console.log($(this).closest("form").find("img[id='form-portrait']"))
    })







      // -----delete checkbox logic
      $('#delete_image_button').on('click', function(){
        $('#delete_check_box').prop('checked', true);
        var portrait = $('#form-portrait')[0]
        // console.log(portrait)
        portrait.src = "/static/static/image/empty_portrait.jpg"
        // console.log($('#form-portrait'))
      })


      $('#save_button').on('click', function(){


        var username_input = $('#inputUsername').val()
        var password_input = $('#inputPassword').val()
        var repeat_password_input = $('#inputRepeatPassword').val()

        var delete_image = $('#delete_check_box').prop('checked')
        var email_input = $('#inputEmail').val()

        // console.log('---------')
        // console.log(delete_image)
        // console.log('---------')


        if(delete_image == false){
          photo_input = $('#imageform')[0];
          var fd = new FormData(photo_input);

        } else {
          var fd = new FormData();
        }

        // var fd = new FormData(photo_input);
        fd.append('email', email_input)
        fd.append('delete_image', delete_image)
        fd.append('username', username_input)
        fd.append('password', password_input)
        fd.append('repeat_password', repeat_password_input)


        $.ajax({
            url: window.location.href.replace('profile/', 'update_profile/'),
            type: "POST",
            data: fd,
            contentType: false,
            processData: false,

            success: function (result) {
              // console.log('Allright!')
              // console.log(result)
              if (result['status'] == 'updated'){
                if (result['data'].hasOwnProperty("username")){
                  for(element of $("[class^='username']")){
                    $(element).text(result['data']['username'])
                  }

                }

                if (result['data']['photo_url'] != null){
                  $("[class^='portrait_jpg']").each(function(image_obj){
                    $(this)[0].src=result['data']['photo_url']
                  })

                $('#inputPassword').val('')
                $('#inputRepeatPassword').val('')
                }
                toastr.success(`Відомості про користувача ${result['data']['email']} змінено!`)
              } else {
                console.log(typeof result['errors'])
                console.log(result['errors'])
                for (key in result['errors']){
                  toastr.warning(`${key}: ${result['errors'][key]}`)
                }
              }
            },

            error: function(){
              console.log('Error!')
              console.log(fd)
            },

          });


      })


      // work with sockets

      var cookie_data = document.cookie


      for (var cookie of cookie_data.split('; ')){
      if (cookie.startsWith('access_token=')){
      var access_token = cookie.replace('access_token=', '')}}
      var socket_address_local = "ws://127.0.0.1:5000/profile_wallets"
      var socket_address_deploy = "wss://crypto-wallet-socketio.lfvimh.easypanel.host/profile_wallets"
      if (window.location.protocol == "https:"){
        console.log('=======Https!!!======')
        var socket_address = socket_address_deploy
      } else {
        console.log('=======local!!!======')
        var socket_address = socket_address_local
      }
      console.log('=====socket_address=====')
      console.log(window.location.protocol)
      console.log(socket_address)
      console.log('========================')

      var profile_wallet_socket = io("wss://crypto-wallet-socketio.lfvimh.easypanel.host/profile_wallets", {
          path: "/socket/ws/socket.io",
          // transports: ["websocket"],
          auth: {
            token: access_token
          }
        })




      // connect logic
      profile_wallet_socket.on('connect', () => {
          console.log('connected to wallets');
        })

      // disconnect logic
      profile_wallet_socket.on('disconnect', () => {
          console.log('disconnected from wallets');
          $('div[id^="wallet_"]').remove();
          // console.log()
        })



      profile_wallet_socket.on('return_list_of_user_wallets', (wallet_data) => {
        console.log('-->>>This is wallet data!')
        console.log(wallet_data)
        all_users_wallets = wallet_data['all_users_wallets']

        for (wallet_id in all_users_wallets){
          $('#profile_wallet_container').prepend(

          `<div class="col-12 col-lg-6" id=wallet_${wallet_id}>
            <div class="card border-0 mb-3" style="max-height: 100px;">
              <div class="row g-0">
                <div class="col-2">
                  <img src="${all_users_wallets[wallet_id]['blockchain_photo']}" class="ethereum_icon img-fluid rounded-start" style="max-height: 100px;" alt="Лого крипти">
                </div>
                <div class="col-10">
                  <div class="card-body">
                    <p class="card-text border">${all_users_wallets[wallet_id]['address']}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>`

            )
          console.log(wallet_id)
          }

        console.log('-------------------------')
      });


      $('#create_etc_wallet_button').on('click', function(){
        profile_wallet_socket.emit("create_wallet", data={"token": access_token})
      })


      $('#send_import_wallet_data').on('click', function(){
        var private_key_obj = $('#adding_wallet_private_key')
        if (private_key_obj.val()){
          // console.log(`Private key is ${private_key.val()}`)
          var private_key = private_key_obj.val()
          console.log('***')
          console.log(private_key)
          console.log('***')
          private_key_obj.val("")
          profile_wallet_socket.emit("import_wallet", data={"token": access_token, 'private_key': private_key})

        } else {
          // console.log('Private key is EMPTY!!!')
          toastr.warning('Для того, щоб імпортувати гаманець, введіть приватний ключ гаманця.')
        }

      })


      profile_wallet_socket.on('show_new_wallet', (data) => {
        console.log('You want to show new wallet!')
        console.log(data)
        if(data['status'] == 'success'){
        $(`
        <div class="col-12 col-lg-6" id=wallet_${data['id']}>
            <div class="card border-0 mb-3" style="max-height: 100px;">
              <div class="row g-0">
                <div class="col-2">
                  <img src="${data['blockchain_photo']}" class="ethereum_icon img-fluid rounded-start" style="max-height: 100px;" alt="Лого крипти">
                </div>
                <div class="col-10">
                  <div class="card-body">
                    <p class="card-text border">${data['address']}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).insertBefore($('#adding_buttons'))} else {

          toastr.warning(data['text'])

        }

      })

  })
  }


  toastr.options = {
        "closeButton": true,
        "debug": false,
        "newestOnTop": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "preventDuplicates": true,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "10000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    }

</script>

  </body>
</html>
